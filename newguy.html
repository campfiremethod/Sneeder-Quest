<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico" />
    <title>Sneeder Quest - New Character Wizard</title>
    <!-- 98.css library -->
    <link rel="stylesheet" href="https://unpkg.com/98.css" />
    <script src="json2.js"></script>
    <script src="jquery-3.6.0.js"></script>
    <script src="utils.js"></script>
    <script src="config.js"></script>
    <script src="newguy.js"></script>
    <script type="module">
      import { faker } from "https://esm.sh/@faker-js/faker";
      window.fakerModule = faker;
    </script>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="stylesheet" href="/styles/newguy.css" />
  </head>

  <body>
    <div class="wizard-container">
      <div class="window wizard-window">
        <div class="title-bar">
          <div class="title-bar-text">Sneeder Quest - New Character Wizard</div>
          <div class="title-bar-controls">
            <button
              aria-label="Close"
              onclick="window.location.href='roster.html'"
            ></button>
          </div>
        </div>

        <div class="window-body wizard-body">
          <!-- Sidebar -->
          <div class="sidebar">
            <ul class="tree-view">
              <li id="sidebar-step-1">1. Choose Race</li>
              <li id="sidebar-step-2">2. Choose Class</li>
              <li id="sidebar-step-3">3. Roll Stats</li>
              <li id="sidebar-step-4">4. Finalize</li>
            </ul>
          </div>

          <!-- Main content -->
          <div class="main-content">
            <!-- Step 1: Race Selection -->
            <div class="step-content active" id="step-race">
              <div class="step-title">Choose Your Race</div>
              <div class="step-description">
                Select a race for your character. Each race has different stat
                bonuses and abilities.
              </div>
              <div class="content-area">
                <div class="selection-panel">
                  <fieldset>
                    <legend>Races</legend>
                    <div class="table-container">
                      <table class="selection-table" id="races-table">
                        <thead>
                          <tr>
                            <th style="width: 30px"></th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody id="races">
                          <!-- Race rows will be inserted here -->
                        </tbody>
                      </table>
                    </div>
                  </fieldset>
                </div>
                <div class="description-panel">
                  <fieldset>
                    <legend>Description</legend>
                    <div class="description-content" id="race-description">
                      <div class="no-selection">
                        Select a race to view its description
                      </div>
                    </div>
                  </fieldset>
                </div>
              </div>
            </div>

            <!-- Step 2: Class Selection -->
            <div class="step-content" id="step-class">
              <div class="step-title">Choose Your Class</div>
              <div class="step-description">
                Select a class that determines your character's skills and
                abilities.
              </div>
              <div class="content-area">
                <div class="selection-panel">
                  <fieldset>
                    <legend>Classes</legend>
                    <div class="table-container">
                      <table class="selection-table" id="classes-table">
                        <thead>
                          <tr>
                            <th style="width: 30px"></th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody id="classes">
                          <!-- Class rows will be inserted here -->
                        </tbody>
                      </table>
                    </div>
                  </fieldset>
                </div>
                <div class="description-panel">
                  <fieldset>
                    <legend>Description</legend>
                    <div class="description-content" id="class-description">
                      <div class="no-selection">
                        Select a class to view its description
                      </div>
                    </div>
                  </fieldset>
                </div>
              </div>
            </div>

            <!-- Step 3: Stats -->
            <div class="step-content" id="step-stats">
              <div class="step-title">Roll Your Statistics</div>
              <div class="step-description">
                Roll for your character's base statistics. You can reroll if
                you're not satisfied with the results.
              </div>
              <div class="content-area">
                <div class="stats-panel">
                  <fieldset>
                    <legend>Character Statistics</legend>
                    <table class="stats-table">
                      <thead>
                        <tr>
                          <th>Stat</th>
                          <th>Value</th>
                        </tr>
                      </thead>
                      <tbody id="Stats">
                        <tr>
                          <td>STR</td>
                          <td id="STR">10</td>
                        </tr>
                        <tr>
                          <td>CON</td>
                          <td id="CON">10</td>
                        </tr>
                        <tr>
                          <td>DEX</td>
                          <td id="DEX">10</td>
                        </tr>
                        <tr>
                          <td>INT</td>
                          <td id="INT">10</td>
                        </tr>
                        <tr>
                          <td>WIS</td>
                          <td id="WIS">10</td>
                        </tr>
                        <tr>
                          <td>CHA</td>
                          <td id="CHA">10</td>
                        </tr>
                        <tr class="stats-total">
                          <td><strong>Total</strong></td>
                          <td id="Total">60</td>
                        </tr>
                      </tbody>
                    </table>
                    <div class="button-group">
                      <button class="btn" id="Reroll">Reroll</button>
                      <button class="btn" id="Unroll" disabled>Undo</button>
                    </div>
                  </fieldset>
                </div>
              </div>
            </div>

            <!-- Step 4: Finalize -->
            <div class="step-content" id="step-details">
              <div class="step-title">Finalize Your Character</div>
              <div class="step-description">
                Enter your character's name and review your choices.
              </div>
              <div class="content-area">
                <div class="details-panel">
                  <fieldset>
                    <legend>Character Details</legend>
                    <div class="form-group">
                      <label for="Name">Character Name:</label>
                      <input
                        type="text"
                        id="Name"
                        placeholder="Enter character name"
                      />
                      <div class="button-group">
                        <button class="btn" id="RandomName">Random Name</button>
                      </div>
                    </div>

                    <div class="multiplayer-section">
                      <fieldset>
                        <legend>Game Mode</legend>
                        <div class="field-row">
                          <input
                            type="radio"
                            id="singleplayer"
                            name="gamemode"
                            value="singleplayer"
                            checked
                          />
                          <label for="singleplayer">Singleplayer</label>
                        </div>
                        <div class="field-row">
                          <input
                            type="radio"
                            id="multiplayer"
                            name="gamemode"
                            value="multiplayer"
                            disabled
                          />
                          <label for="multiplayer">Multiplayer</label>
                        </div>
                      </fieldset>
                    </div>

                    <div class="character-summary">
                      <div class="summary-title">Character Summary</div>
                      <div class="summary-row">
                        <span class="summary-label">Name:</span>
                        <span class="summary-value" id="summary-name"
                          >Not set</span
                        >
                      </div>
                      <div class="summary-row">
                        <span class="summary-label">Race:</span>
                        <span class="summary-value" id="summary-race"
                          >Not selected</span
                        >
                      </div>
                      <div class="summary-row">
                        <span class="summary-label">Class:</span>
                        <span class="summary-value" id="summary-class"
                          >Not selected</span
                        >
                      </div>
                    </div>
                  </fieldset>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Status/Button Bar -->
        <div class="status-bar">
          <div class="status-left" id="step-info">Step 1 of 4</div>
          <div class="status-right">
            <button
              class="btn"
              id="back-button"
              onclick="previousStep()"
              disabled
            >
              ← Back
            </button>
            <button class="btn primary" id="next-button" onclick="nextStep()">
              Next →
            </button>
            <button
              class="btn primary"
              id="finish-button"
              onclick="createCharacter()"
              style="display: none"
            >
              Create Character
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden compatibility elements -->
    <div style="display: none">
      <button id="Sold"></button>
      <div id="races-hidden"></div>
      <div id="classes-hidden"></div>
    </div>

    <script>
      let currentStep = 1;
      let selectedRace = null;
      let selectedClass = null;

      function updateSidebar() {
        for (let i = 1; i <= 4; i++) {
          const sidebarItem = document.getElementById(`sidebar-step-${i}`);
          if (i < currentStep) {
            sidebarItem.className = "completed";
          } else if (i === currentStep) {
            sidebarItem.className = "active";
          } else {
            sidebarItem.className = "";
          }
        }
      }

      function updateButtons() {
        const backButton = document.getElementById("back-button");
        const nextButton = document.getElementById("next-button");
        const finishButton = document.getElementById("finish-button");
        const stepInfo = document.getElementById("step-info");

        backButton.disabled = currentStep === 1;
        stepInfo.textContent = `Step ${currentStep} of 4`;

        if (currentStep === 4) {
          nextButton.style.display = "none";
          finishButton.style.display = "inline-block";
        } else {
          nextButton.style.display = "inline-block";
          finishButton.style.display = "none";

          // Enable/disable next button based on step completion
          if (currentStep === 1) {
            nextButton.disabled = !selectedRace;
          } else if (currentStep === 2) {
            nextButton.disabled = !selectedClass;
          } else {
            nextButton.disabled = false;
          }
        }
      }

      function showStep(step) {
        // Hide all steps
        document.querySelectorAll(".step-content").forEach((content) => {
          content.classList.remove("active");
        });

        // Show current step
        const stepMap = {
          1: "step-race",
          2: "step-class",
          3: "step-stats",
          4: "step-details",
        };

        document.getElementById(stepMap[step]).classList.add("active");
        updateSidebar();
        updateButtons();

        if (step === 4) {
          updateCharacterSummary();
        }
      }

      function nextStep() {
        if (currentStep < 4) {
          currentStep++;
          showStep(currentStep);
        }
      }

      function previousStep() {
        if (currentStep > 1) {
          currentStep--;
          showStep(currentStep);
        }
      }

      function updateCharacterSummary() {
        document.getElementById("summary-name").textContent =
          traits.Name || "Not set";
        document.getElementById("summary-race").textContent =
          traits.Race || "Not selected";
        document.getElementById("summary-class").textContent =
          traits.Class || "Not selected";
        document.getElementById("summary-total").textContent = total || 60;
      }

      function updateDescription(type, name) {
        const descriptionPanel = document.getElementById(`${type}-description`);

        // For now, just show the name and bonus without detailed descriptions
        let description = "No description... yet...";

        // You can add descriptions later by creating a descriptions object like:
        // const descriptions = {
        //   races: {
        //     "Pigman": "A proud swine-human hybrid with excellent health.",
        //     "Ashkenazi Jew": "Naturally charismatic and well-connected.",
        //     // ... etc
        //   },
        //   classes: {
        //     "Life Insurance Salesman": "Wise and hardy from dealing with difficult customers.",
        //     // ... etc
        //   }
        // };

        let bonus = "";
        if (type === "race") {
          const raceData = K.Races.find((r) => r.split("|")[0] === name);
          if (raceData) {
            bonus = raceData.split("|")[1];
          }
        } else if (type === "class") {
          const classData = K.Klasses.find((c) => c.split("|")[0] === name);
          if (classData) {
            bonus = classData.split("|")[1];
          }
        }

        descriptionPanel.innerHTML = `
    <div class="description-title">${name}</div>
    ${bonus ? `<div class="description-bonus">Bonus: +${bonus}</div>` : ""}
    <div class="description-text">${description}</div>
  `;
      }

      function createCharacter() {
        if (!traits.Name || !traits.Race || !traits.Class) {
          alert("Please complete all steps before creating your character.");
          return;
        }
        sold();
      }

      // Override the fill function for table-based selection
      window.originalFill = fill;
      window.fill = function (selector, array, traitName) {
        const container = $(selector);
        container.empty();

        array.forEach((item, index) => {
          const [name, bonus] = item.split("|");

          const row = $("<tr></tr>");
          row.attr("data-value", name);
          row.attr("data-trait", traitName);

          row.html(`
            <td class="selector-cell"></td>
            <td>${name}</td>
          `);

          row.on("click", function () {
            // Clear previous selections in this table
            $(this)
              .siblings("tr")
              .each(function () {
                $(this).find(".selector-cell").text("");
              });

            // Add arrow to current selection
            $(this).find(".selector-cell").text("►");

            const selectedValue = $(this).attr("data-value");
            const traitType = $(this).attr("data-trait");
            traits[traitType] = selectedValue;

            if (traitType === "Race") {
              selectedRace = selectedValue;
              updateDescription("race", selectedValue);
            } else if (traitType === "Class") {
              selectedClass = selectedValue;
              updateDescription("class", selectedValue);
            }

            updateButtons();
          });

          container.append(row);
        });
      };

      // Initialize when document is ready
      $(document).ready(function () {
        NewGuyFormLoad();
        showStep(1);

        // Handle name changes
        document.getElementById("Name").addEventListener("input", function () {
          traits.Name = this.value;
          if (currentStep === 4) {
            updateCharacterSummary();
          }
        });

        // Handle random name generation
        document
          .getElementById("RandomName")
          .addEventListener("click", function () {
            GenClick();
            document.getElementById("Name").value = traits.Name;
            if (currentStep === 4) {
              updateCharacterSummary();
            }
          });

        // Update total when stats change
        const originalRollEm = window.RollEm;
        window.RollEm = function () {
          originalRollEm();
          if (currentStep === 4) {
            setTimeout(updateCharacterSummary, 100);
          }
        };
      });
    </script>
  </body>
</html>
