<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico" />
    <title>Sneeder Quest - Configuration Editor</title>
    <!-- 98.css library -->
    <link rel="stylesheet" href="https://unpkg.com/98.css" />
    <link rel="stylesheet" href="/styles/config-editor.css" />
  </head>
  <body>
    <div class="editor-container">
      <div class="window editor-window">
        <div class="title-bar">
          <div class="title-bar-text">Sneeder Quest - Configuration Editor</div>
          <div class="title-bar-controls">
            <button aria-label="Minimize"></button>
            <button aria-label="Maximize"></button>
            <button aria-label="Close"></button>
          </div>
        </div>

        <!-- Category Tabs -->
        <div class="category-tabs-container">
          <menu role="tablist" class="category-tabs">
            <!-- Category tabs will be populated here -->
          </menu>
        </div>

        <div class="editor-body">
          <!-- Left Sidebar -->
          <div class="sidebar">
            <fieldset>
              <legend>Sections</legend>
              <ul class="section-list" id="sectionList">
                <!-- Sections for active category will be populated here -->
              </ul>
            </fieldset>

            <fieldset>
              <legend>Actions</legend>
              <button
                onclick="saveConfig()"
                style="width: 100%; margin-bottom: 4px"
              >
                üíæ Save Config
              </button>
              <button
                onclick="exportJSON()"
                style="width: 100%; margin-bottom: 4px"
              >
                üìÑ Export JSON
              </button>
              <button onclick="loadConfigFile()" style="width: 100%">
                üìÅ Load Config
              </button>
            </fieldset>
          </div>

          <!-- Main Content Area -->
          <div class="content-area">
            <div class="content-header">
              <div class="section-title" id="sectionTitle">
                Select a category
              </div>
              <div class="action-buttons">
                <button onclick="showAddForm()">Add Item</button>
                <button onclick="deleteSelected()" disabled id="deleteBtn">
                  Delete
                </button>
              </div>
            </div>

            <!-- Add Form -->
            <div class="add-form" id="addForm">
              <div class="form-row">
                <label for="newItemInput">Item:</label>
                <input
                  type="text"
                  id="newItemInput"
                  placeholder="Enter new item name"
                />
                <button onclick="addItem()">Add</button>
                <button onclick="hideAddForm()">Cancel</button>
              </div>
            </div>

            <!-- Items Container -->
            <div class="items-container">
              <div class="items-table-wrapper">
                <div id="contentArea">
                  <!-- Section content will be populated here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Right Stats Panel -->
          <div class="stats-panel">
            <fieldset>
              <legend>Current Section</legend>
              <div id="currentStats">
                <div class="stat-item">
                  <span>Total Items:</span>
                  <span class="stat-value" id="totalItems">0</span>
                </div>
                <div class="stat-item">
                  <span>Selected:</span>
                  <span class="stat-value" id="selectedCount">0</span>
                </div>
              </div>
            </fieldset>

            <fieldset>
              <legend>Overall Stats</legend>
              <div id="overallStats">
                <!-- Overall stats will be populated here -->
              </div>
            </fieldset>
          </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
          <div class="status-left" id="statusText">Ready</div>
          <div class="status-right" id="statusRight">No file loaded</div>
        </div>
      </div>
    </div>

    <script>
      // Configuration data - will be loaded from config.js
      let K = {};
      let originalConfigText = "";
      let selectedItems = new Set();
      let currentCategory = "";
      let currentSection = "";

      // Organized sections into categories
      const sectionCategories = {
        Character: ["Races", "Klasses", "Titles", "ImpressiveTitles", "Spells"],
        Equipment: [
          "Weapons",
          "Accessories",
          "Headwear",
          "Eyewear",
          "BodyArmor",
          "Jackets",
          "Gloves",
          "Wristwear",
          "Belts",
          "Legwear",
          "Footwear",
          "Armors",
        ],
        Attributes: [
          "OffenseAttrib",
          "DefenseAttrib",
          "OffenseBad",
          "DefenseBad",
        ],
        "Items & Loot": ["Specials", "ItemAttrib", "ItemOfs", "BoringItems"],
        "Combat & Enemies": ["Monsters", "MonMods"],
      };

      const wantedSections = Object.values(sectionCategories).flat();

      function initializeEditor() {
        renderCategories();
        renderSectionList(Object.keys(sectionCategories)[0]); // Render first category's sections
        loadConfigFromFile();
        updateStatus("Editor initialized", "Ready");
      }

      function renderCategories() {
        const categoryTabs = document.querySelector(".category-tabs");

        categoryTabs.innerHTML = "";

        Object.keys(sectionCategories).forEach((category, index) => {
          // Create tab for category
          const tabItem = document.createElement("li");
          tabItem.setAttribute("role", "tab");
          if (index === 0) {
            tabItem.setAttribute("aria-selected", "true");
          }

          const tabLink = document.createElement("a");
          tabLink.href = "#";
          tabLink.textContent = category;
          tabLink.onclick = (e) => {
            e.preventDefault();
            selectCategory(category);
          };

          tabItem.appendChild(tabLink);
          categoryTabs.appendChild(tabItem);
        });
      }

      function renderSectionList(category) {
        const sectionList = document.getElementById("sectionList");
        sectionList.innerHTML = "";

        sectionCategories[category].forEach((section) => {
          const sectionItem = document.createElement("li");
          sectionItem.className = "section-item";
          sectionItem.textContent = section;
          sectionItem.onclick = () => {
            selectSection(category, section);
          };
          sectionList.appendChild(sectionItem);
        });
      }

      function selectCategory(category) {
        // Clear previous tab selections
        document.querySelectorAll('[role="tab"]').forEach((tab) => {
          tab.removeAttribute("aria-selected");
        });

        // Activate selected tab
        const categoryTabs = document.querySelectorAll('[role="tab"]');
        const targetTab = Array.from(categoryTabs).find(
          (tab) => tab.textContent.trim() === category
        );

        if (targetTab) {
          targetTab.setAttribute("aria-selected", "true");
        }

        currentCategory = category;

        // Update the section list for this category
        renderSectionList(category);

        // Auto-select first section in category
        const firstSection = sectionCategories[category][0];
        selectSection(category, firstSection);
      }

      function selectSection(category, section) {
        // Clear previous section selections
        document.querySelectorAll(".section-item").forEach((item) => {
          item.classList.remove("active");
        });

        // Activate selected section
        const sectionItems = document.querySelectorAll(".section-item");
        const targetSection = Array.from(sectionItems).find(
          (item) => item.textContent === section
        );

        if (targetSection) {
          targetSection.classList.add("active");
        }

        currentSection = section;
        document.getElementById("sectionTitle").textContent = section;
        renderSectionContent(section);
        updateCurrentStats(section);
        hideAddForm();
      }

      function renderSectionContent(section) {
        const contentArea = document.getElementById("contentArea");

        if (!K[section]) {
          contentArea.innerHTML =
            '<p style="text-align: center; padding: 20px; color: #666;">No data available for this section.</p>';
          return;
        }

        const tableWrapper = document.createElement("div");
        tableWrapper.style.height = "100%";
        tableWrapper.style.overflow = "auto";

        const table = document.createElement("table");
        table.className = "items-table";

        // Create header
        const thead = document.createElement("thead");
        thead.innerHTML = `
          <tr>
            <th style="width: 40px">#</th>
            <th>Item Name</th>
            <th style="width: 120px">Actions</th>
          </tr>
        `;
        table.appendChild(thead);

        // Create body
        const tbody = document.createElement("tbody");
        K[section].forEach((item, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${item}</td>
            <td class="item-actions">
              <button onclick="editItem('${section}', ${index})">Edit</button>
              <button onclick="deleteItem('${section}', ${index})">Delete</button>
            </td>
          `;

          row.onclick = (e) => {
            if (e.target.tagName !== "BUTTON") {
              toggleRowSelection(row, index);
            }
          };

          tbody.appendChild(row);
        });
        table.appendChild(tbody);

        contentArea.innerHTML = "";
        contentArea.appendChild(table);
      }

      function toggleRowSelection(row, index) {
        if (row.classList.contains("selected")) {
          row.classList.remove("selected");
          selectedItems.delete(index);
        } else {
          row.classList.add("selected");
          selectedItems.add(index);
        }

        document.getElementById("selectedCount").textContent =
          selectedItems.size;
        document.getElementById("deleteBtn").disabled =
          selectedItems.size === 0;
      }

      function updateCurrentStats(section) {
        const totalItems = K[section] ? K[section].length : 0;
        document.getElementById("totalItems").textContent = totalItems;
        document.getElementById("selectedCount").textContent =
          selectedItems.size;

        selectedItems.clear();
        document.getElementById("deleteBtn").disabled = true;
      }

      function updateOverallStats() {
        const overallStats = document.getElementById("overallStats");
        overallStats.innerHTML = "";

        Object.keys(sectionCategories).forEach((category) => {
          const categoryTotal = sectionCategories[category].reduce(
            (sum, section) => {
              return sum + (K[section] ? K[section].length : 0);
            },
            0
          );

          const statItem = document.createElement("div");
          statItem.className = "stat-item";
          statItem.innerHTML = `
            <span>${category}:</span>
            <span class="stat-value">${categoryTotal}</span>
          `;
          overallStats.appendChild(statItem);
        });
      }

      function showAddForm() {
        document.getElementById("addForm").classList.add("active");
        document.getElementById("newItemInput").focus();
      }

      function hideAddForm() {
        document.getElementById("addForm").classList.remove("active");
        document.getElementById("newItemInput").value = "";
      }

      function addItem() {
        const input = document.getElementById("newItemInput");
        const newItem = input.value.trim();

        if (newItem && currentSection) {
          if (!K[currentSection]) {
            K[currentSection] = [];
          }

          K[currentSection].push(newItem);
          input.value = "";
          hideAddForm();
          renderSectionContent(currentSection);
          updateCurrentStats(currentSection);
          updateOverallStats();
          updateStatus(`Added "${newItem}" to ${currentSection}`, "Modified");
        }
      }

      function editItem(section, index) {
        const currentValue = K[section][index];
        const newValue = prompt("Edit item:", currentValue);

        if (newValue !== null && newValue.trim() !== "") {
          K[section][index] = newValue.trim();
          renderSectionContent(section);
          updateStatus(`Edited item in ${section}`, "Modified");
        }
      }

      function deleteItem(section, index) {
        if (confirm("Are you sure you want to delete this item?")) {
          const itemName = K[section][index];
          K[section].splice(index, 1);
          renderSectionContent(section);
          updateCurrentStats(section);
          updateOverallStats();
          updateStatus(`Deleted "${itemName}" from ${section}`, "Modified");
        }
      }

      function deleteSelected() {
        if (selectedItems.size === 0) return;

        if (confirm(`Delete ${selectedItems.size} selected items?`)) {
          const sortedIndexes = Array.from(selectedItems).sort((a, b) => b - a);
          sortedIndexes.forEach((index) => {
            K[currentSection].splice(index, 1);
          });

          selectedItems.clear();
          renderSectionContent(currentSection);
          updateCurrentStats(currentSection);
          updateOverallStats();
          updateStatus(
            `Deleted ${sortedIndexes.length} items from ${currentSection}`,
            "Modified"
          );
        }
      }

      function updateStatus(message, status) {
        document.getElementById("statusText").textContent = message;
        document.getElementById("statusRight").textContent = status;
      }

      async function loadConfigFromFile() {
        try {
          const response = await fetch("config.js");
          const configText = await response.text();
          originalConfigText = configText;

          // Parse the config file
          wantedSections.forEach((section) => {
            const regex = new RegExp(
              `K\\.${section}\\s*=\\s*\\[([\\s\\S]*?)\\];`,
              "i"
            );
            const match = configText.match(regex);

            if (match) {
              try {
                const arrayContent = "[" + match[1] + "]";
                K[section] = eval(arrayContent);
              } catch (parseError) {
                console.warn(`Could not parse ${section}:`, parseError);
                K[section] = [];
              }
            } else {
              console.warn(`Section ${section} not found in config.js`);
              K[section] = [];
            }
          });

          updateOverallStats();
          updateStatus(
            "Config file loaded successfully",
            `${Object.keys(K).length} sections loaded`
          );

          // Auto-select first category and section
          const firstCategory = Object.keys(sectionCategories)[0];
          selectCategory(firstCategory);
        } catch (error) {
          console.error("Error loading config file:", error);
          updateStatus("Error loading config.js", "Error");
        }
      }

      function loadConfigFile() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".js";
        input.onchange = function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                originalConfigText = e.target.result;
                // Parse the loaded file same way as loadConfigFromFile
                wantedSections.forEach((section) => {
                  const regex = new RegExp(
                    `K\\.${section}\\s*=\\s*\\[([\\s\\S]*?)\\];`,
                    "i"
                  );
                  const match = originalConfigText.match(regex);

                  if (match) {
                    try {
                      const arrayContent = "[" + match[1] + "]";
                      K[section] = eval(arrayContent);
                    } catch (parseError) {
                      console.warn(`Could not parse ${section}:`, parseError);
                      K[section] = [];
                    }
                  } else {
                    K[section] = [];
                  }
                });

                updateOverallStats();
                if (currentSection) {
                  renderSectionContent(currentSection);
                  updateCurrentStats(currentSection);
                }
                updateStatus(`Loaded ${file.name}`, "File loaded");
              } catch (error) {
                updateStatus("Error parsing file", "Error");
              }
            };
            reader.readAsText(file);
          }
        };
        input.click();
      }

      function saveConfig() {
        if (!originalConfigText) {
          alert(
            "Cannot save: No original config.js was loaded. Use Export instead."
          );
          return;
        }

        try {
          let updatedConfig = originalConfigText;

          wantedSections.forEach((section) => {
            if (K[section]) {
              const regex = new RegExp(
                `(K\\.${section}\\s*=\\s*\\[)[\\s\\S]*?(\\];)`,
                "i"
              );

              const newArrayContent = K[section]
                .map((item) => `  "${item}"`)
                .join(",\n");
              const replacement = `$1\n${newArrayContent}\n$2`;

              updatedConfig = updatedConfig.replace(regex, replacement);
            }
          });

          const blob = new Blob([updatedConfig], { type: "text/javascript" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "config.js";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          updateStatus("Config saved successfully", "Saved");
        } catch (error) {
          updateStatus("Error saving config", "Error");
          console.error("Save error:", error);
        }
      }

      function exportJSON() {
        const jsonText = JSON.stringify(K, null, 2);
        const blob = new Blob([jsonText], { type: "application/json" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "config.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        updateStatus("JSON exported successfully", "Exported");
      }

      // Initialize the editor when page loads
      document.addEventListener("DOMContentLoaded", function () {
        initializeEditor();
      });
    </script>
  </body>
</html>
