<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="shortcut icon" type="image/x-icon" href="assets/favicon.ico" />
    <title>Sneeder Quest - Roster</title>
    <!-- 98.css library -->
    <link rel="stylesheet" href="https://unpkg.com/98.css" />
    <link rel="stylesheet" href="styles/roster.css" />
  </head>

  <body>
    <div class="main-container">
      <div class="window main-window">
        <div class="title-bar">
          <div class="title-bar-text">Sneeder Quest - Roster</div>
          <div class="title-bar-controls">
            <button aria-label="Close" onclick="window.close()"></button>
          </div>
        </div>

        <div class="header-section">
          <div class="header-content">
            <div class="ascii-logo" id="ascii-logo"></div>
          </div>
        </div>

        <div class="content-area">
          <!-- Character Table -->
          <div class="characters-table-container">
            <table class="characters-table" id="characters-table">
              <thead>
                <tr>
                  <th style="width: 30px"></th>
                  <th style="width: 160px">Character</th>
                  <th style="width: 80px">Level</th>
                  <th style="width: 100px">Race</th>
                  <th style="width: 100px">Class</th>
                  <th style="width: 140px">Act</th>
                  <th style="width: 120px">Best Equipment</th>
                </tr>
              </thead>
              <tbody id="characters-tbody">
                <!-- Character rows will be inserted here -->
              </tbody>
            </table>
            <div class="empty-state" id="empty-state" style="display: none">
              No saved characters found.<br />
              Create a new character to begin your adventure.
            </div>
          </div>
          <!-- Status Bar -->
          <div class="status-bar">
            <span class="character-count" id="character-count"
              >0 characters</span
            >
            <span class="selection-info" id="selection-info"
              >No character selected</span
            >
          </div>
          <!-- Actions Panel -->
          <div class="actions-panel">
            <button class="btn" id="new-character">New Character</button>
            <button class="btn" id="play-selected" disabled>
              Play Selected
            </button>
            <button class="btn" id="delete-selected" disabled>
              Delete Selected
            </button>
            <button class="btn" id="export-selected" disabled>
              Export Selected
            </button>
            <button class="btn" id="clear-roster">Clear All</button>
          </div>

          <!-- File Management -->
          <div class="file-management">
            <div class="file-management-title">Character Data Management</div>
            <div class="file-management-text">
              Your character data exists only in this browser. Save backup files
              to prevent data loss. You can load saved character files (.pqw)
              using the button below.
            </div>
            <div
              class="file-input-wrapper"
              onclick="document.getElementById('file-input').click()"
            >
              <input
                type="file"
                id="file-input"
                accept=".pqw"
                multiple
                style="display: none"
              />
              Load Character Files
            </div>
          </div>
        </div>

        <!-- Footer -->
        <!-- <div class="footer-section">a thing by camp</div> -->
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      // Storage utility functions (from original roster.js)
      function b64_decode(value) {
        return JSON.parse(decodeURIComponent(escape(atob(value))));
      }

      function b64_stringify(value) {
        return btoa(unescape(encodeURIComponent(JSON.stringify(value))));
      }

      // Storage interface (from utils.js)
      const storage = {
        loadRoster: function (callback) {
          if (!window.localStorage) {
            callback({});
            return;
          }
          const roster = localStorage.getItem("roster");
          let games = {};
          if (roster) {
            try {
              games = JSON.parse(roster);
            } catch (err) {
              // Handle parsing errors
            }
          }
          callback(games || {});
        },

        storeRoster: function (games, callback) {
          if (window.localStorage) {
            localStorage.setItem("roster", JSON.stringify(games));
          }
          if (callback) callback();
        },

        addToRoster: function (character, callback) {
          this.loadRoster((games) => {
            games[character.Traits.Name] = character;
            this.storeRoster(games, callback);
          });
        },
      };

      class CharacterRoster {
        constructor() {
          this.characters = {};
          this.selectedCharacter = null;
          this.init();
          this.loadCharacters();
        }

        init() {
          // Event listeners
          document
            .getElementById("new-character")
            .addEventListener("click", () => {
              window.location.href = "newguy.html";
            });

          document
            .getElementById("play-selected")
            .addEventListener("click", () => {
              if (this.selectedCharacter) {
                window.location.href = `main.html#${encodeURIComponent(
                  this.selectedCharacter
                )}`;
              }
            });

          document
            .getElementById("delete-selected")
            .addEventListener("click", () => {
              if (this.selectedCharacter) {
                this.deleteCharacter(this.selectedCharacter);
              }
            });

          document
            .getElementById("export-selected")
            .addEventListener("click", () => {
              if (this.selectedCharacter) {
                this.exportCharacter(this.selectedCharacter);
              }
            });

          document
            .getElementById("clear-roster")
            .addEventListener("click", () => {
              if (confirm("Are you sure you want to delete all characters?")) {
                this.clearAllCharacters();
              }
            });

          document
            .getElementById("file-input")
            .addEventListener("change", (e) => {
              this.handleFileLoad(e);
            });

          // Double-click to play character
          document
            .getElementById("characters-tbody")
            .addEventListener("dblclick", (e) => {
              const row = e.target.closest("tr");
              if (row && row.dataset.character) {
                window.location.href = `main.html#${encodeURIComponent(
                  row.dataset.character
                )}`;
              }
            });
        }

        loadCharacters() {
          storage.loadRoster((games) => {
            this.characters = games;
            this.renderCharacterTable();
            this.updateStatusBar();
          });
        }

        renderCharacterTable() {
          const tbody = document.getElementById("characters-tbody");
          const emptyState = document.getElementById("empty-state");

          tbody.innerHTML = "";

          if (Object.keys(this.characters).length === 0) {
            emptyState.style.display = "block";
            return;
          }

          emptyState.style.display = "none";

          Object.entries(this.characters).forEach(([name, character]) => {
            const row = this.createCharacterRow(name, character);
            tbody.appendChild(row);
          });
        }

        createCharacterRow(name, character) {
          const row = document.createElement("tr");
          row.dataset.character = name;

          if (character.online) {
            row.classList.add("online");
          }

          row.addEventListener("click", (e) => {
            this.selectCharacter(name, row);
          });

          const level = character.Traits?.Level || 1;
          const race = character.Traits?.Race || "Unknown";
          const charClass = character.Traits?.Class || "Unknown";
          const currentQuest = character.bestplot || "Prologue";
          const bestEquip = character.bestequip || "None";

          row.innerHTML = `
      <td class="selector-cell"></td>
      <td>
        <span class="character-name">${name}</span>
        ${
          character.online
            ? `<div class="online-indicator">â˜… Realm of ${character.online.realm}</div>`
            : character.motto
            ? `<div class="character-motto">"${character.motto}"</div>`
            : ""
        }
      </td>
      <td>${level}</td>
      <td>${race}</td>
      <td>${charClass}</td>
      <td>${currentQuest}</td>
      <td>${bestEquip}</td>
    `;

          return row;
        }

        selectCharacter(name, rowElement) {
          // Remove previous selection
          document.querySelectorAll(".characters-table tr").forEach((r) => {
            r.classList.remove("selected");
          });

          // Select new character
          this.selectedCharacter = name;
          rowElement.classList.add("selected");

          // Enable/disable buttons
          const playBtn = document.getElementById("play-selected");
          const deleteBtn = document.getElementById("delete-selected");
          const exportBtn = document.getElementById("export-selected");

          playBtn.disabled = false;
          deleteBtn.disabled = false;
          exportBtn.disabled = false;

          this.updateStatusBar();
        }

        deleteCharacter(name) {
          if (confirm(`Are you sure you want to delete ${name}?`)) {
            storage.loadRoster((games) => {
              delete games[name];
              storage.storeRoster(games, () => {
                this.selectedCharacter = null;
                this.loadCharacters();

                // Disable buttons
                document.getElementById("play-selected").disabled = true;
                document.getElementById("delete-selected").disabled = true;
                document.getElementById("export-selected").disabled = true;
              });
            });
          }
        }

        exportCharacter(name) {
          const character = this.characters[name];
          if (character) {
            const dataStr = b64_stringify(character);
            const dataBlob = new Blob([dataStr], { type: "text/plain" });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `${name}.pqw`;
            link.click();
            URL.revokeObjectURL(url);
          }
        }

        clearAllCharacters() {
          storage.storeRoster({}, () => {
            this.selectedCharacter = null;
            this.loadCharacters();

            // Disable buttons
            document.getElementById("play-selected").disabled = true;
            document.getElementById("delete-selected").disabled = true;
            document.getElementById("export-selected").disabled = true;
          });
        }

        updateStatusBar() {
          const count = Object.keys(this.characters).length;
          const countText = count === 1 ? "1 character" : `${count} characters`;
          document.getElementById("character-count").textContent = countText;

          const selectionInfo = this.selectedCharacter
            ? `Selected: ${this.selectedCharacter}`
            : "No character selected";
          document.getElementById("selection-info").textContent = selectionInfo;
        }

        handleFileLoad(event) {
          const files = event.target.files;
          for (let file of files) {
            this.loadCharacterFile(file);
          }
          event.target.value = ""; // Reset file input
        }

        loadCharacterFile(file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              let content = e.target.result.replace(/\s/g, "");
              const characterData = b64_decode(content);

              if (
                characterData &&
                characterData.Traits &&
                characterData.Traits.Name
              ) {
                const name = characterData.Traits.Name;
                if (this.characters[name]) {
                  if (
                    !confirm(
                      `A character named "${name}" already exists. Overwrite it?`
                    )
                  ) {
                    return;
                  }
                }

                storage.addToRoster(characterData, () => {
                  this.loadCharacters();
                });
              } else {
                alert("Invalid character file format.");
              }
            } catch (error) {
              alert("Invalid character data");
              console.log(error);
            }
          };
          reader.readAsText(file);
        }
      }

      // Global functions for compatibility
      function downloadCharacter(name) {
        const character = roster.characters[name];
        if (character) {
          const dataStr = b64_stringify(character);
          const dataBlob = new Blob([dataStr], { type: "text/plain" });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `${name}.pqw`;
          link.click();
          URL.revokeObjectURL(url);
        }
      }

      // Initialize the roster when page loads
      let roster;
      document.addEventListener("DOMContentLoaded", () => {
        roster = new CharacterRoster();

        // Load and display the ASCII logo
        loadLogo();
      });

      // Load ASCII logo from file
      async function loadLogo() {
        try {
          const response = await fetch("assets/logo.txt");
          if (response.ok) {
            const logoText = await response.text();
            document.getElementById("ascii-logo").textContent = logoText;
          }
        } catch (error) {
          console.log("Could not load logo:", error);
          // Fallback text
          document.getElementById("ascii-logo").textContent = "SNEEDER QUEST";
        }
      }
    </script>
  </body>
</html>
