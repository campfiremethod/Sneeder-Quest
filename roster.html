<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="http://progressquest.com/favicon.ico"
    />
    <title>Sneeder Quest - Roster</title>
    <!-- 98.css library -->
    <link rel="stylesheet" href="https://unpkg.com/98.css" />
    <style>
      body {
        background: url("assets/darkaliens.png") no-repeat center center fixed;
        background-size: cover;
        font-family: "MS Sans Serif", sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        box-sizing: border-box;
        overflow: hidden;
      }

      /* Custom title bar color */
      .title-bar {
        background: #9acd32;
        background: linear-gradient(
          90deg,
          rgba(154, 205, 50, 1) 56%,
          rgba(255, 255, 255, 1) 100%
        );
      }
      .title-bar-text {
        color: black;
      }

      .main-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
        box-sizing: border-box;
      }

      .main-window {
        width: 720px;
        min-height: 500px;
      }

      .header-section {
        background: #c0c0c0;
        padding: 20px;
        text-align: center;
        border-bottom: 2px inset #c0c0c0;
        padding-bottom: 0px;
      }

      .header-content {
        text-align: center;
        margin-bottom: 15px;
      }

      .ascii-logo {
        font-family: "Courier New", monospace;
        font-size: 10px;
        line-height: 1;
        color: black;
        font-weight: bold;
        white-space: pre;
        text-align: left;
        margin: 0 auto 15px auto;
        letter-spacing: 0;
        word-spacing: 0;
        overflow: hidden;
        width: fit-content;
        max-width: 100%;
        min-height: 50px;
        margin-bottom: 10px;
      }

      .logo {
        font-family: "Courier New", monospace;
        font-size: 18px;
        font-weight: bold;
        color: black;
        margin-bottom: 5px;
      }

      .main-title {
        font-size: 16px;
        font-weight: bold;
        color: black;
        margin-bottom: 5px;
      }

      .subtitle {
        color: #404040;
        font-size: 11px;
      }

      .content-area {
        flex: 1;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        background: #c0c0c0;
      }

      /* TableView styling for character list */
      .characters-table-container {
        border: 2px inset #c0c0c0;
        background: black;
        max-height: 350px;
        overflow: auto;
      }

      .characters-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
        background: black;
      }

      .characters-table thead {
        background: #c0c0c0;
        border-bottom: 1px solid #808080;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .characters-table th {
        padding: 4px 8px;
        text-align: left;
        border-right: 1px solid #808080;
        font-weight: normal;
        background: #c0c0c0;
        color: black;
      }

      .characters-table th:last-child {
        border-right: none;
      }

      .characters-table tbody tr {
        border-bottom: 1px solid #333;
        cursor: pointer;
        background: black;
      }

      .characters-table tbody tr:hover {
        background: #ffff00;
        color: black;
      }

      .characters-table tbody tr.selected {
        background: #ffff00;
        color: black;
      }

      .characters-table tbody tr.online {
        background: #001100;
        color: #00ff00;
        font-weight: bold;
      }

      .characters-table tbody tr.online:hover,
      .characters-table tbody tr.online.selected {
        background: #ffff00;
        color: black;
      }

      .characters-table td {
        padding: 2px 8px;
        border-right: 1px solid #333;
        vertical-align: top;
        background: black;
        color: #00ff00;
        font-family: "Courier New", monospace;
      }

      .characters-table td:last-child {
        border-right: none;
      }

      .character-name {
        font-weight: bold;
        color: #ffffff !important;
      }

      /* Ensure character names stay white in ALL states */
      .characters-table .character-name,
      .characters-table tbody tr .character-name,
      .characters-table tbody tr:hover .character-name,
      .characters-table tbody tr.selected .character-name,
      .characters-table tbody tr.online .character-name,
      .characters-table tbody tr.online:hover .character-name,
      .characters-table tbody tr.online.selected .character-name {
        color: #ffffff !important;
        font-weight: bold !important;
      }

      .characters-table tbody tr:hover .character-name,
      .characters-table tbody tr.selected .character-name {
        color: black;
      }

      .character-actions {
        display: flex;
        gap: 2px;
        align-items: center;
      }

      .action-btn {
        width: 20px;
        height: 16px;
        border: 1px outset #c0c0c0;
        background: #c0c0c0;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        text-decoration: none;
        color: black;
      }

      .action-btn:hover {
        background: #dfdfdf;
      }

      .action-btn:active {
        border: 1px inset #c0c0c0;
      }

      .play-btn {
        background: #9acd32;
        border-color: #9acd32;
        font-weight: bold;
        width: 24px;
      }

      .play-btn:hover {
        background: #adff2f;
      }

      .empty-state {
        text-align: center;
        color: #808080;
        font-style: italic;
        padding: 60px 20px;
        background: black;
        font-family: "Courier New", monospace;
      }

      .actions-panel {
        display: flex;
        justify-content: center;
        gap: 10px;
        padding: 10px;
        background: #c0c0c0;
        border: 2px inset #c0c0c0;
      }

      .status-bar {
        background: #c0c0c0;
        padding: 4px 8px;
        font-size: 11px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0px;
        margin-top: -10px;
      }

      .character-count {
        color: black;
      }

      .selection-info {
        color: #404040;
        font-style: italic;
      }

      /* Footer styling */
      .footer-section {
        text-align: right;
        color: #808080;
        font-size: 10px;
        padding: 2px;
        padding-top: 0px;
        margin-top: 0px;
        padding-bottom: 0px;
        background: #c0c0c0;
      }

      /* File management section styling */
      .file-management {
        border: 2px inset #c0c0c0;
        background: #c0c0c0;
        padding: 12px;
      }

      .file-management-title {
        font-weight: bold;
        margin-bottom: 6px;
        color: black;
        font-size: 11px;
      }

      .file-management-text {
        font-size: 10px;
        color: #404040;
        margin-bottom: 8px;
        line-height: 1.3;
      }

      .file-input-wrapper {
        display: inline-block;
        position: relative;
        overflow: hidden;
        border: 1px outset #c0c0c0;
        background: #c0c0c0;
        padding: 2px 8px;
        cursor: pointer;
        font-size: 11px;
        color: black;
      }

      .file-input-wrapper:hover {
        background: #dfdfdf;
      }

      .file-input-wrapper input[type="file"] {
        position: absolute;
        left: -9999px;
      }

      /* Responsive adjustments */
      @media (max-width: 800px) {
        .main-window {
          width: 95%;
          min-width: 600px;
        }

        .characters-table {
          font-size: 10px;
        }
      }
    </style>
  </head>

  <body>
    <div class="main-container">
      <div class="window main-window">
        <div class="title-bar">
          <div class="title-bar-text">Sneeder Quest - Roster</div>
          <div class="title-bar-controls">
            <button aria-label="Close" onclick="window.close()"></button>
          </div>
        </div>

        <div class="header-section">
          <div class="header-content">
            <div class="ascii-logo" id="ascii-logo"></div>
          </div>
        </div>

        <div class="content-area">
          <!-- Character Table -->
          <div class="characters-table-container">
            <table class="characters-table" id="characters-table">
              <thead>
                <tr>
                  <th style="width: 30px"></th>
                  <th style="width: 160px">Character</th>
                  <th style="width: 80px">Level</th>
                  <th style="width: 100px">Race</th>
                  <th style="width: 100px">Class</th>
                  <th style="width: 140px">Act</th>
                  <th style="width: 120px">Best Equipment</th>
                </tr>
              </thead>
              <tbody id="characters-tbody">
                <!-- Character rows will be inserted here -->
              </tbody>
            </table>
            <div class="empty-state" id="empty-state" style="display: none">
              No saved characters found.<br />
              Create a new character to begin your adventure.
            </div>
          </div>
          <!-- Status Bar -->
          <div class="status-bar">
            <span class="character-count" id="character-count"
              >0 characters</span
            >
            <span class="selection-info" id="selection-info"
              >No character selected</span
            >
          </div>
          <!-- Actions Panel -->
          <div class="actions-panel">
            <button class="btn" id="new-character">New Character</button>
            <button class="btn" id="play-selected" disabled>
              Play Selected
            </button>
            <button class="btn" id="delete-selected" disabled>
              Delete Selected
            </button>
            <button class="btn" id="clear-roster">Clear All</button>
          </div>

          <!-- File Management -->
          <div class="file-management">
            <div class="file-management-title">Character Data Management</div>
            <div class="file-management-text">
              Your character data exists only in this browser. Save backup files
              to prevent data loss. You can load saved character files (.pqw)
              using the button below.
            </div>
            <div class="file-input-wrapper">
              <input type="file" id="file-input" accept=".pqw" multiple />
              Load Character Files
            </div>
          </div>
        </div>

        <!-- Footer -->
        <!-- <div class="footer-section">a thing by camp</div> -->
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      // Storage utility functions (from original roster.js)
      function b64_decode(value) {
        return JSON.parse(decodeURIComponent(escape(atob(value))));
      }

      function b64_stringify(value) {
        return btoa(unescape(encodeURIComponent(JSON.stringify(value))));
      }

      // Storage interface (from utils.js)
      const storage = {
        loadRoster: function (callback) {
          if (!window.localStorage) {
            callback({});
            return;
          }
          const roster = localStorage.getItem("roster");
          let games = {};
          if (roster) {
            try {
              games = JSON.parse(roster);
            } catch (err) {
              // Handle parsing errors
            }
          }
          callback(games || {});
        },

        storeRoster: function (games, callback) {
          if (window.localStorage) {
            localStorage.setItem("roster", JSON.stringify(games));
          }
          if (callback) callback();
        },

        addToRoster: function (character, callback) {
          this.loadRoster((games) => {
            games[character.Traits.Name] = character;
            this.storeRoster(games, callback);
          });
        },
      };

      class CharacterRoster {
        constructor() {
          this.characters = {};
          this.selectedCharacter = null;
          this.init();
          this.loadCharacters();
        }

        init() {
          // Event listeners
          document
            .getElementById("new-character")
            .addEventListener("click", () => {
              window.location.href = "newguy.html";
            });

          document
            .getElementById("play-selected")
            .addEventListener("click", () => {
              if (this.selectedCharacter) {
                window.location.href = `main.html#${encodeURIComponent(
                  this.selectedCharacter
                )}`;
              }
            });

          document
            .getElementById("delete-selected")
            .addEventListener("click", () => {
              if (this.selectedCharacter) {
                this.deleteCharacter(this.selectedCharacter);
              }
            });

          document
            .getElementById("clear-roster")
            .addEventListener("click", () => {
              if (confirm("Are you sure you want to delete all characters?")) {
                this.clearAllCharacters();
              }
            });

          document
            .getElementById("file-input")
            .addEventListener("change", (e) => {
              this.handleFileLoad(e);
            });

          // Double-click to play character
          document
            .getElementById("characters-tbody")
            .addEventListener("dblclick", (e) => {
              const row = e.target.closest("tr");
              if (row && row.dataset.character) {
                window.location.href = `main.html#${encodeURIComponent(
                  row.dataset.character
                )}`;
              }
            });
        }

        loadCharacters() {
          storage.loadRoster((games) => {
            this.characters = games;
            this.renderCharacterTable();
            this.updateStatusBar();
          });
        }

        renderCharacterTable() {
          const tbody = document.getElementById("characters-tbody");
          const emptyState = document.getElementById("empty-state");

          tbody.innerHTML = "";

          if (Object.keys(this.characters).length === 0) {
            emptyState.style.display = "block";
            return;
          }

          emptyState.style.display = "none";

          Object.entries(this.characters).forEach(([name, character]) => {
            const row = this.createCharacterRow(name, character);
            tbody.appendChild(row);
          });
        }

        createCharacterRow(name, character) {
          const row = document.createElement("tr");
          row.dataset.character = name;

          if (character.online) {
            row.classList.add("online");
          }

          row.addEventListener("click", (e) => {
            this.selectCharacter(name, row);
          });

          const level = character.Traits?.Level || 1;
          const race = character.Traits?.Race || "Unknown";
          const charClass = character.Traits?.Class || "Unknown";
          const currentQuest = character.bestplot || "Prologue";
          const bestEquip = character.bestequip || "None";

          row.innerHTML = `
            <td class="selector-cell"></td>
            <td>
              <span class="character-name">${name}</span>
              ${
                character.online
                  ? `<br><small style="color: #666;">Online: ${character.online.realm}</small>`
                  : ""
              }
            </td>
            <td>${level}</td>
            <td>${race}</td>
            <td>${charClass}</td>
            <td>${currentQuest}</td>
            <td>${bestEquip}</td>
          `;

          return row;
        }

        selectCharacter(name, row) {
          // Remove previous selection
          document
            .querySelectorAll(".characters-table tbody tr")
            .forEach((tr) => {
              tr.classList.remove("selected");
              // Clear previous arrows
              const selectorCell = tr.querySelector(".selector-cell");
              if (selectorCell) {
                selectorCell.textContent = "";
              }
            });

          // Add selection to current row
          row.classList.add("selected");
          this.selectedCharacter = name;

          // Add arrow to selector cell
          const selectorCell = row.querySelector(".selector-cell");
          if (selectorCell) {
            selectorCell.textContent = "►";
          }

          // Update buttons
          document.getElementById("play-selected").disabled = false;
          document.getElementById("delete-selected").disabled = false;

          this.updateStatusBar();
        }

        deleteCharacter(name) {
          if (confirm(`Are you sure you want to delete ${name}?`)) {
            delete this.characters[name];

            storage.storeRoster(this.characters, () => {
              if (this.selectedCharacter === name) {
                this.selectedCharacter = null;
                document.getElementById("play-selected").disabled = true;
                document.getElementById("delete-selected").disabled = true;
              }

              this.renderCharacterTable();
              this.updateStatusBar();
            });
          }
        }

        clearAllCharacters() {
          this.characters = {};
          this.selectedCharacter = null;
          document.getElementById("play-selected").disabled = true;
          document.getElementById("delete-selected").disabled = true;

          storage.storeRoster(this.characters, () => {
            this.renderCharacterTable();
            this.updateStatusBar();
          });
        }

        updateStatusBar() {
          const count = Object.keys(this.characters).length;
          const countText = count === 1 ? "1 character" : `${count} characters`;
          document.getElementById("character-count").textContent = countText;

          const selectionInfo = this.selectedCharacter
            ? `Selected: ${this.selectedCharacter}`
            : "No character selected";
          document.getElementById("selection-info").textContent = selectionInfo;
        }

        handleFileLoad(event) {
          const files = event.target.files;
          for (let file of files) {
            this.loadCharacterFile(file);
          }
          event.target.value = ""; // Reset file input
        }

        loadCharacterFile(file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              let content = e.target.result.replace(/\s/g, "");
              const characterData = b64_decode(content);

              if (
                characterData &&
                characterData.Traits &&
                characterData.Traits.Name
              ) {
                const name = characterData.Traits.Name;
                if (this.characters[name]) {
                  if (
                    !confirm(
                      `A character named "${name}" already exists. Overwrite it?`
                    )
                  ) {
                    return;
                  }
                }

                storage.addToRoster(characterData, () => {
                  this.loadCharacters();
                });
              } else {
                alert("Invalid character file format.");
              }
            } catch (error) {
              alert("Invalid character data");
              console.log(error);
            }
          };
          reader.readAsText(file);
        }
      }

      // Global functions for compatibility
      function downloadCharacter(name) {
        const character = roster.characters[name];
        if (character) {
          const dataStr = b64_stringify(character);
          const dataBlob = new Blob([dataStr], { type: "text/plain" });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `${name}.pqw`;
          link.click();
          URL.revokeObjectURL(url);
        }
      }

      // Initialize the roster when page loads
      let roster;
      document.addEventListener("DOMContentLoaded", () => {
        roster = new CharacterRoster();

        // Load and display the ASCII logo
        loadLogo();
      });

      // Load ASCII logo from file
      async function loadLogo() {
        try {
          const response = await fetch("assets/logo.txt");
          if (response.ok) {
            const logoText = await response.text();
            document.getElementById("ascii-logo").textContent = logoText;
          }
        } catch (error) {
          console.log("Could not load logo:", error);
          // Fallback text
          document.getElementById("ascii-logo").textContent = "SNEEDER QUEST";
        }
      }
    </script>
  </body>
</html>
