<!-- File path: main.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="shortcut icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- 98.css library -->
    <link rel="stylesheet" href="https://unpkg.com/98.css" />
    <title>Sneeder Quest</title>
    <meta name="mobile-web-app-capable" content="yes" />

    <meta
      name="viewport"
      content="initial-scale=1.0,
               maximum-scale=1.0,
               minimum-scale=1.0,
               user-scalable=0"
    />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link rel="apple-touch-icon" href="touch-icon.png" />
    <link rel="stylesheet" href="styles/game.css" />
    <style>
      /* Log button styling */
      .log-button {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 1000;
        font-size: 11px;
        min-width: auto;
        padding: 2px 6px;
      }

      /* Popup log window styling */
      .log-window {
        position: fixed;
        top: 100px;
        left: 100px;
        width: 600px;
        height: 400px;
        z-index: 9999;
        display: none;
        background: #c0c0c0;
        border: 2px outset #c0c0c0;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
      }

      .log-window.active {
        display: block;
      }

      .log-window .title-bar {
        cursor: move;
        user-select: none;
      }

      .log-content {
        height: calc(100% - 80px);
        overflow-y: auto;
        background: #000;
        color: green;
        font-family: "Courier New", monospace;
        font-size: 11px;
        padding: 8px;
        margin: 8px;
        border: 2px inset #c0c0c0;
        white-space: pre-wrap;
      }

      .log-entry {
        margin-bottom: 2px;
        line-height: 1.2;
      }

      .log-timestamp {
        color: darkseagreen;
        margin-right: 8px;
      }

      .log-controls {
        padding: 8px;
        display: flex;
        gap: 8px;
        justify-content: center;
        background: #c0c0c0;
      }

      .log-controls button {
        min-width: 60px;
        font-size: 11px;
      }

      /* Window dragging */
      /* .dragging {
        opacity: 0.8;
      } */
    </style>
  </head>

  <body>
    <br />

    <div class="vbox window" id="main">
      <div class="title-bar" id="titlebar">
        <div class="title-bar-text">
          <span id="title">Sneeder Quest</span>
        </div>
        <div class="title-bar-controls">
          <button aria-label="Close" onclick="window.close()"></button>
        </div>
      </div>

      <!-- Log Button -->
      <button
        class="log-button"
        onclick="openLogWindow()"
        title="Open Activity Log"
      >
        📜 Log
      </button>

      <script src="json2.js"></script>
      <script src="jquery-3.6.0.js"></script>
      <script src="utils.js"></script>
      <script src="utils/math-utils.js"></script>
      <script src="utils/string-utils.js"></script>
      <script src="utils/name-generator.js"></script>
      <script src="config.js"></script>
      <script src="ui/ui-utils.js"></script>
      <script src="ui/progressbar.js"></script>
      <script src="ui/listbox.js"></script>
      <script src="game/monster-generator.js"></script>
      <script src="game/item-generator.js"></script>
      <script src="game/character-progression.js"></script>
      <script src="network/online-features.js"></script>
      <script src="ui/form-management.js"></script>
      <script src="main.js"></script>
      <script src="game/location-system.js"></script>
      <script src="game/skills-system.js"></script>
      <script>
        // Load skills database before starting game
        $.getJSON("data/skills.json", function (data) {
          window.SkillsDB = data;
          // Continue with normal game initialization
        }).fail(function () {
          console.warn("Could not load skills.json, using basic skill system");
          window.SkillsDB = {};
        });
      </script>

      <script type="module">
        import { faker } from "https://esm.sh/@faker-js/faker";
        window.fakerModule = faker;
      </script>

      <div class="hbox">
        <div class="vbox" id="Izquierda">
          <fieldset>
            <legend>Character Sheet</legend>
            <table class="listbox" id="Trats">
              <thead>
                <tr>
                  <th>Trait</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody id="Traits">
                <tr>
                  <td>Name</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Race</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Class</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Level</td>
                  <td>1</td>
                </tr>
              </tbody>

              <thead class="mid">
                <tr>
                  <th>Stat</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody id="Stats">
                <tr>
                  <td>STR</td>
                  <td></td>
                </tr>
                <tr>
                  <td>CON</td>
                  <td></td>
                </tr>
                <tr>
                  <td>DEX</td>
                  <td></td>
                </tr>
                <tr>
                  <td>INT</td>
                  <td></td>
                </tr>
                <tr>
                  <td>WIS</td>
                  <td></td>
                </tr>
                <tr>
                  <td>CHA</td>
                  <td></td>
                </tr>
                <tr>
                  <td>HP Max</td>
                  <td></td>
                </tr>
                <tr>
                  <td>TP Max</td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </fieldset>

          <div class="label">Experience</div>
          <div class="progress-container" id="ExpBar">
            <div class="hint"></div>
            <div class="bar"></div>
          </div>

          <fieldset>
            <legend>Life Skills</legend>
            <div id="Skills" class="scroll listbox">
              <table>
                <thead>
                  <tr>
                    <th class="key">Skill</th>
                    <th class="value">Level</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </fieldset>
        </div>

        <div class="vbox" id="Centro">
          <fieldset>
            <legend>Equipment</legend>
            <table id="Equips" class="listbox">
              <tbody>
                <tr>
                  <td>Weapon</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Accessory</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Headwear</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Eyewear</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Body Armor</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Jacket</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Gloves</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Wristwear</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Belt</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Legwear</td>
                  <td></td>
                </tr>
                <tr>
                  <td>Footwear</td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </fieldset>

          <fieldset>
            <legend>Inventory</legend>
            <div id="Inventory" class="scroll listbox">
              <table>
                <thead>
                  <tr>
                    <th class="key">Item</th>
                    <th class="value">Qty</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </fieldset>

          <div class="label">Encumbrance</div>
          <div class="progress-container" id="EncumBar">
            <div class="hint"></div>
            <div class="bar"></div>
          </div>
        </div>

        <div class="vbox" id="Derecha">
          <fieldset>
            <legend>Plot Development</legend>
            <div id="Plots" class="scroll listbox">
              <table>
                <tbody></tbody>
              </table>
            </div>
          </fieldset>

          <div class="progress-container" id="PlotBar">
            <div class="hint"></div>
            <div class="bar"></div>
          </div>

          <fieldset>
            <legend>Location</legend>
            <div class="status-line location-status">
              <span id="current-location">Loading...</span>
            </div>
          </fieldset>

          <fieldset>
            <legend>Quests</legend>
            <div id="Quests" class="scroll listbox">
              <table>
                <tbody></tbody>
              </table>
            </div>
          </fieldset>
          <div class="progress-container" id="QuestBar">
            <div class="hint"></div>
            <div class="bar"></div>
          </div>
        </div>
      </div>
      <div id="Kill" class="label"></div>

      <div class="progress-container" id="TaskBar">
        <div class="hint"></div>
        <div class="bar"></div>
      </div>
    </div>

    <!-- Popup Log Window -->
    <div class="log-window" id="logWindow">
      <div class="title-bar" id="logTitleBar">
        <div class="title-bar-text">Activity Log - Sneeder Quest</div>
        <div class="title-bar-controls">
          <button aria-label="Close" onclick="closeLogWindow()"></button>
        </div>
      </div>
      <div class="window-body" style="padding: 0; height: calc(100% - 32px)">
        <div class="log-content" id="logContent">
          <div class="log-entry">No activity logged yet...</div>
        </div>
        <div class="log-controls">
          <button onclick="refreshLog()">🔄 Refresh</button>
          <button onclick="clearLog()">🗑️ Clear</button>
          <button onclick="exportLog()">💾 Export</button>
          <button onclick="autoScrollToggle()" id="autoscrollBtn">
            Auto-scroll: ON
          </button>
        </div>
      </div>
    </div>

    <div id="bsodmom">
      <div id="bsod">
        <p class="c"><span>&nbsp;Sneeder Quest&nbsp;</span></p>
        <p>&nbsp;</p>
        <p>An error has occurred.</p>
        <p>Error:</p>
        <p id="bsod_message"></p>
        <p>
          In <span id="bsod_source"></span> at
          <span id="bsod_lineno"></span>:<span id="bsod_colno"></span>
        </p>
        <p id="bsod_error"></p>
        <p class="c">Press any key to continue...</p>
      </div>
    </div>

    <div id="paused"><br />PAUSED</div>

    <!-- Activity Log System -->
    <script>
      // Activity log system
      let activityLog = [];
      const MAX_LOG_ENTRIES = 100;
      let autoScroll = true;

      // Override the original Log function to capture entries
      const originalLog = window.Log || function () {};
      window.Log = function (line) {
        // Call original Log function
        if (originalLog && typeof originalLog === "function") {
          originalLog(line);
        }

        // Add to our activity log
        const timestamp = new Date().toLocaleTimeString();
        activityLog.push({
          time: timestamp,
          message: line,
          fullTimestamp: Date.now(),
        });

        // Keep only last 100 entries
        if (activityLog.length > MAX_LOG_ENTRIES) {
          activityLog.shift();
        }

        // Update log display if window is open
        const logWindow = document.getElementById("logWindow");
        if (logWindow && logWindow.classList.contains("active")) {
          updateLogDisplay();
        }
      };

      // Window dragging functionality
      let isDragging = false;
      let dragOffset = { x: 0, y: 0 };

      function initializeLogWindowDragging() {
        const titleBar = document.getElementById("logTitleBar");
        const logWindow = document.getElementById("logWindow");

        titleBar.addEventListener("mousedown", (e) => {
          isDragging = true;
          logWindow.classList.add("dragging");
          const rect = logWindow.getBoundingClientRect();
          dragOffset.x = e.clientX - rect.left;
          dragOffset.y = e.clientY - rect.top;
          e.preventDefault();
        });

        document.addEventListener("mousemove", (e) => {
          if (isDragging) {
            const logWindow = document.getElementById("logWindow");
            const newX = e.clientX - dragOffset.x;
            const newY = e.clientY - dragOffset.y;

            // Keep window within viewport
            const maxX = window.innerWidth - logWindow.offsetWidth;
            const maxY = window.innerHeight - logWindow.offsetHeight;

            logWindow.style.left = Math.max(0, Math.min(newX, maxX)) + "px";
            logWindow.style.top = Math.max(0, Math.min(newY, maxY)) + "px";
          }
        });

        document.addEventListener("mouseup", () => {
          if (isDragging) {
            isDragging = false;
            const logWindow = document.getElementById("logWindow");
            logWindow.classList.remove("dragging");
          }
        });
      }

      // Open log window
      function openLogWindow() {
        const logWindow = document.getElementById("logWindow");
        logWindow.classList.add("active");
        updateLogDisplay();

        // Bring to front
        logWindow.style.zIndex = 10000;
      }

      // Close log window
      function closeLogWindow() {
        const logWindow = document.getElementById("logWindow");
        logWindow.classList.remove("active");
      }

      // Update the log display
      function updateLogDisplay() {
        const logContainer = document.getElementById("logContent");

        if (activityLog.length === 0) {
          logContainer.innerHTML =
            '<div class="log-entry">No activity logged yet...</div>';
          return;
        }

        // Show entries in reverse order (newest first)
        const entries = activityLog.slice().reverse();
        logContainer.innerHTML = "";

        entries.forEach((entry) => {
          const logEntry = document.createElement("div");
          logEntry.className = "log-entry";
          logEntry.innerHTML = `<span class="log-timestamp">[${entry.time}]</span>${entry.message}`;
          logContainer.appendChild(logEntry);
        });

        // Auto-scroll to top if enabled
        if (autoScroll) {
          logContainer.scrollTop = 0;
        }
      }

      // Clear log function
      function clearLog() {
        if (confirm("Clear all log entries?")) {
          activityLog = [];
          updateLogDisplay();
        }
      }

      // Export log function
      function exportLog() {
        if (activityLog.length === 0) {
          alert("No log entries to export.");
          return;
        }

        const logText = activityLog
          .map((entry) => `[${entry.time}] ${entry.message}`)
          .join("\n");

        const blob = new Blob([logText], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `sneeder-quest-log-${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Refresh log function
      function refreshLog() {
        updateLogDisplay();
      }

      // Auto-scroll toggle function
      function autoScrollToggle() {
        autoScroll = !autoScroll;
        const btn = document.getElementById("autoscrollBtn");
        btn.textContent = `Auto-scroll: ${autoScroll ? "ON" : "OFF"}`;

        if (autoScroll) {
          const logContainer = document.getElementById("logContent");
          logContainer.scrollTop = 0;
        }
      }

      // Initialize dragging when page loads
      document.addEventListener("DOMContentLoaded", function () {
        initializeLogWindowDragging();
      });
    </script>
  </body>
</html>
